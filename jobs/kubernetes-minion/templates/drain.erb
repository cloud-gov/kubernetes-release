#!/bin/bash

# Drain and cordon node

set -e
set -x

PATH=$PATH:/var/vcap/packages/kubernetes/bin

LOG_DIR=/var/vcap/sys/log/kubernetes-minion
LOG_FILE=${LOG_DIR}/drain.log

mkdir -p ${LOG_DIR}

exec 3>&1
exec 1>> ${LOG_FILE}
exec 2>> ${LOG_FILE}

# Choose first non-self address; using self fails if etcd drain script runs first
<% addr = spec.networks.to_h.values.first.ip %>
API_HOST=<%= p('apiserver.hosts').select {|ip| ip != addr}.first %>

NODE=$(curl http://169.254.169.254/latest/meta-data/hostname)

# if we are in the cluster, then drain
kubectl -s http://${API_HOST}:8080 get node | grep $HOSTNAME && kubectl -s http://${API_HOST}:8080 drain $HOSTNAME --force


echo 0 >&3
exit 0
